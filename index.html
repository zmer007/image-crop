<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/css/image.css"

  </head>
  <body style="position: relative" onload="listRawImage()">
    <div class="main_content_container">
      <div class="resize_fit_center">
        <img id="myImage" onload="imageSize()"/>
      </div>
      <canvas class="cnvs" id='myCanvas' width="500px" height="500px" onmousedown="mouseDown(this, event)"
        onmousemove='mouseMove(this, event)' onmouseup="mouseUp(event)"/>
    </div>
    <div class="right_list_conatiner" width="300px" height="600px">
        <div class="help_message_coantainer">
          <label id="mLabel">这个框里放说明</label>
        </div>
        <div>
          <img id="managed_image_top_l" />
          <img id="managed_image_top_r" />
        </div>
        <div>
          <img id="managed_image_mid_l" />
          <img id="managed_image_mid_r" />
        </div>
        <div>
          <img id="managed_image_btm_l" />
          <img id="managed_image_btm_r" />
        </div>
    </div>
    <div id="bottom_container" class="bottom_list_conatiner">
      <img id="raw_image_0"/>
      <img id="raw_image_1"/>
      <img id="raw_image_2"/>
      <img id="raw_image_3"/>
      <img id="raw_image_4"/>
    </div>
  </body>

  <script>
    const fs = require('fs')
    const clipper = require('image-clipper')

    const canvas = document.getElementById('myCanvas')
    const ctx = canvas.getContext('2d')
    const mImg = document.getElementById('myImage')
    const mLabel = document.getElementById('mLabel')
    const mBottomCantainer = document.getElementById('bottom_container')
    window.onkeydown = keyDown
    window.onkeyup = keyUp

    const RAW_DIR = '/Users/lgd/Desktop/tmp_data/raw/'
    const MANAGED_DIR = '/Users/lgd/Desktop/tmp_data/manage/'

    // 键盘监听事件
    const KEY_CODE_SHIFT = 16
    const KEY_CODE_CTRL = 17
    const KEY_CODE_CMD = 91

    class Rect{
      constructor(left, top, right, bottom){
        this.left = left
        this.top = top
        this.right = right
        this.bottom = bottom
      }
    }

    var mIsShiftPressed = false;
    var mIsCtrlPressed = false;
    var mIsCmdPressed = false;

    var beginDraw = false
    var mAllRawFiles = []
    var mRawBuff = []
    var mManagedBuff = []
    var mRawBuff2 = []
    var mCurrentImageName='';

    var mRects = []
    var mImgRect = new Rect(0, 0, 0, 0)
    var mDragRect = new Rect(0, 0, 0, 0)

    var mRawImage0 = document.getElementById('raw_image_0')
    var mRawImage1 = document.getElementById('raw_image_1')
    var mRawImage2 = document.getElementById('raw_image_2')
    var mRawImage3 = document.getElementById('raw_image_3')
    var mRawImage4 = document.getElementById('raw_image_4')
    var mRawImages = [mRawImage0, mRawImage1, mRawImage2, mRawImage3, mRawImage4]

    var mManagedImageBtmL = document.getElementById('managed_image_btm_l')
    var mManagedImageBtmR = document.getElementById('managed_image_btm_r')
    var mManagedImageMidL = document.getElementById('managed_image_mid_l')
    var mManagedImageMidR = document.getElementById('managed_image_mid_r')
    var mManagedImageTopL = document.getElementById('managed_image_top_l')
    var mManagedImageTopR = document.getElementById('managed_image_top_r')
    var mManagedImageL = [mManagedImageBtmL, mManagedImageMidL, mManagedImageTopL]
    var mManagedImageR = [mManagedImageBtmR, mManagedImageMidR, mManagedImageTopR]

    function mouseDown(obj, ev){
      if (ev.button == 2){
        saveImage(mCurrentImageName)
        fetchCurrentImagePath()
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        return
      }

      mDragRect.left = ev.clientX
      mDragRect.top = ev.clientY
      beginDraw = true
      ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    function mouseMove(obj, ev){
      if(beginDraw){
        ctx.strokeStyle = '#ff0000'
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        mDragRect.right = ev.clientX
        mDragRect.bottom = ev.clientY
        if(mIsShiftPressed){
            mDragRect.right = mDragRect.right > mDragRect.bottom ? mDragRect.right : mDragRect.bottom
            mDragRect.bottom =  mDragRect.right
        }
        ctx.strokeRect(mDragRect.left, mDragRect.top, mDragRect.right - mDragRect.left, mDragRect.bottom - mDragRect.top);
        ctx.fillStyle = '#000'
        ctx.fillText("("+mDragRect.right+", "+mDragRect.bottom+")", mDragRect.right, mDragRect.bottom);
      }
    }

    function mouseUp(ev){
      beginDraw = false
      if(mIsCmdPressed || mIsCtrlPressed){
        return
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      var width = mImgRect.right - mImgRect.left
      var height = mImgRect.bottom - mImgRect.top
      var ratio = height > width ? height / 500 : width / 500;
      var l = (mDragRect.left - mImgRect.left) * ratio
      var t = (mDragRect.top - mImgRect.top) * ratio
      var r = (mDragRect.right - mImgRect.left) * ratio
      var b = (mDragRect.bottom - mImgRect.top) * ratio
      var rect = new Rect(l, t, r, b)
      mLabel.innerHTML = (rect.right - rect.left) + " : " + (rect.bottom - rect.top) + "<br>"
      mLabel.innerHTML = mImgRect.left + " : " + mImgRect.top
      cropImage(mCurrentImageName, rect)
    }

    function cropImage(fileName, rect){
      clipper(RAW_DIR + fileName, function() {
        this.crop(rect.left, rect.top, rect.right-rect.left, rect.bottom-rect.top)
        .quality(100)
        .toFile(MANAGED_DIR + fileName, function() {
          mRawBuff2.unshift(fileName)
          mManagedBuff.unshift(fileName)
          if(mRawBuff2.length > 3){
            mRawBuff2.pop()
            mManagedBuff.pop()
          }
          notifyRaw2BuffChanged()
          fetchCurrentImagePath()
        });
      });
    }

    function saveImage(fileName){
      if(fileName == undefined){
        return
      }
      copyFile(RAW_DIR + fileName, MANAGED_DIR + fileName, function cb(err) {
        if(err){
          return
        }
        mRawBuff2.unshift(fileName)
        mManagedBuff.unshift(fileName)
        if(mRawBuff2.length > 3){
          mRawBuff2.pop()
          mManagedBuff.pop()
        }
        notifyRaw2BuffChanged()
      })
    }

    function imageSize(){
      var naturalWidth = mImg.naturalWidth
      var naturalHeight = mImg.naturalHeight
      if(naturalWidth > naturalHeight){
        var relativeHeight = naturalHeight / naturalWidth * 500
        var offset = (500 - relativeHeight) / 2
        mImgRect = new Rect(0, offset, 500, 500-offset*2)
      }else{
        var relativeWidth = naturalWidth / naturalHeight * 500
        var offset = (500 - relativeWidth) / 2
        mImgRect = new Rect(offset, 0, 500 - offset * 2, 500)
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.strokeStyle = '#00f'
      ctx.strokeRect(mImgRect.left, mImgRect.top, mImgRect.right, mImgRect.bottom)
    }

    function copyFile(source, target, cb) {
      var cbCalled = false;

      var rd = fs.createReadStream(source);
      rd.on("error", function(err) {
        done(err);
      });
      var wr = fs.createWriteStream(target);
      wr.on("error", function(err) {
        done(err);
      });
      wr.on("close", function(ex) {
        done();
      });
      rd.pipe(wr);

      function done(err) {
        if (!cbCalled) {
          cb(err);
          cbCalled = true;
        }
      }
    }

    function listRawImage() {

      fs.readdir(RAW_DIR, function(err, files){
        if(err){
          mLabel.innerHTML += "error"
        }

        files.forEach(function(fileName){
          mAllRawFiles.unshift(fileName)
        })

        var path = mAllRawFiles.pop()
        mRawBuff.unshift(path)
        while(mRawBuff.length < mRawImages.length){
          path = mAllRawFiles.pop()
          mRawBuff.unshift(path)
        }
        fetchCurrentImagePath()
      })
    }

    function fetchCurrentImagePath(){
      mRawBuff.unshift(mAllRawFiles.pop())
      mCurrentImageName = mRawBuff.pop()
      if(mCurrentImageName != undefined){
        mImg.src = "file://"+RAW_DIR + mCurrentImageName
        notifyRawBuffChanged()
      }
    }

    function notifyRawBuffChanged(){
      for (var i=0; i<mRawBuff.length && i<mRawImages.length; i++){
        mRawImages[i].src = RAW_DIR + mRawBuff[i]
      }
    }

    function notifyRaw2BuffChanged(){
      for (var i=0; i<mRawBuff2.length && i<mManagedImageL.length; i++){
        mManagedImageL[i].src = RAW_DIR + mRawBuff2[i]
        mManagedImageR[i].src = MANAGED_DIR + mManagedBuff[i]
      }
    }

    function keyDown(event){
      switch (event.keyCode) {
        case KEY_CODE_CMD:
          mIsCmdPressed = true
          break;
        case KEY_CODE_CTRL:
          mIsCtrlPressed = true
          break;
        case KEY_CODE_SHIFT:
          mIsShiftPressed = true
          break;
      }
    }

    function keyUp(event){
      switch (event.keyCode) {
        case KEY_CODE_CMD:
          mIsCmdPressed = false
          break;
        case KEY_CODE_CTRL:
          mIsCtrlPressed = false
          break;
        case KEY_CODE_SHIFT:
          mIsShiftPressed = false
          break;
      }
    }

  </script>
</html>
