<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/css/image.css"

  </head>
  <body style="position: relative" onload="listRawImage()">
    <div class="main_content_container">
      <div class="resize_fit_center">
        <img id="myImage" />
      </div>
      <canvas class="cnvs" id='myCanvas' width="500px" height="500px" onmousedown="mouseDown(this, event)"
        onmousemove='mouseMove(this, event)' onmouseup="mouseUp()"/>
    </div>
    <div class="right_list_conatiner" width="300px" height="600px">
        <div class="help_message_coantainer">
          <label id="mLabel">这个框里放说明</label>
        </div>
        <div>
          <img id="managed_image_top_l" />
          <img id="managed_image_top_r" />
        </div>
        <div>
          <img id="managed_image_mid_l" />
          <img id="managed_image_mid_r" />
        </div>
        <div>
          <img id="managed_image_btm_l" />
          <img id="managed_image_btm_r" />
        </div>
    </div>
    <div id="bottom_container" class="bottom_list_conatiner">
      <img id="raw_image_0"/>
      <img id="raw_image_1"/>
      <img id="raw_image_2"/>
      <img id="raw_image_3"/>
      <img id="raw_image_4"/>
    </div>
  </body>

  <script>
    fs = require('fs')
    clipper = require('image-clipper')

    canvas = document.getElementById('myCanvas')
    ctx = canvas.getContext('2d')
    mImg = document.getElementById('myImage')
    mLabel = document.getElementById('mLabel')
    mBottomCantainer = document.getElementById('bottom_container')
    window.onkeydown = keyDown
    window.onkeyup = keyUp

    const RAW_DIR = '/Users/lgd/Desktop/tmp_data/raw/'
    const MANAGED_DIR = '/Users/lgd/Desktop/tmp_data/manage/'

    // 键盘监听事件
    const KEY_CODE_SHIFT = 16
    const KEY_CODE_CTRL = 17
    const KEY_CODE_CMD = 91

    var mIsShiftPressed = false;
    var mIsCtrlPressed = false;
    var mIsCmdPressed = false;

    var x = 0, y = 0
    var beginDraw = false
    var mAllRawFiles = []
    var mRawBuff = []
    var mManagedBuff = []
    var mRawBuff2 = []
    var mCurrentImageName='';

    var mRects = []

    var mRawImage0 = document.getElementById('raw_image_0')
    var mRawImage1 = document.getElementById('raw_image_1')
    var mRawImage2 = document.getElementById('raw_image_2')
    var mRawImage3 = document.getElementById('raw_image_3')
    var mRawImage4 = document.getElementById('raw_image_4')
    var mRawImages = [mRawImage0, mRawImage1, mRawImage2, mRawImage3, mRawImage4]

    var mManagedImageBtmL = document.getElementById('managed_image_btm_l')
    var mManagedImageBtmR = document.getElementById('managed_image_btm_r')
    var mManagedImageMidL = document.getElementById('managed_image_mid_l')
    var mManagedImageMidR = document.getElementById('managed_image_mid_r')
    var mManagedImageTopL = document.getElementById('managed_image_top_l')
    var mManagedImageTopR = document.getElementById('managed_image_top_r')
    var mManagedImageL = [mManagedImageBtmL, mManagedImageMidL, mManagedImageTopL]
    var mManagedImageR = [mManagedImageBtmR, mManagedImageMidR, mManagedImageTopR]

    function mouseDown(obj, ev){
      if (ev.button == 2){
        saveImage()
        fetchCurrentImagePath()
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        return
      }
      x = ev.clientX
      y = ev.clientY
      beginDraw = true
      ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    function mouseMove(obj, ev){
      if(beginDraw){
        ctx.strokeStyle = '#ff0000'
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        var endX = ev.clientX - x;
        var endY = ev.clientY - y;
        if(mIsShiftPressed){
            endX = endX > endY ? endX : endY
            endY = endX
        }
        ctx.strokeRect(x, y, endX, endY);
      }
    }

    function mouseUp(){
      beginDraw = false
      ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    function saveImage(){
      if(mCurrentImageName == undefined){
        return
      }
      fs.createReadStream(RAW_DIR + mCurrentImageName)
        .pipe(fs.createWriteStream(MANAGED_DIR + mCurrentImageName));
    }

    function listRawImage() {

      fs.readdir(RAW_DIR, function(err, files){
        if(err){
          mLabel.innerHTML += "error"
        }

        files.forEach(function(fileName){
          mAllRawFiles.unshift(fileName)
        })

        var path = mAllRawFiles.pop()
        mRawBuff.unshift(path)
        while(mRawBuff.length < mRawImages.length){
          path = mAllRawFiles.pop()
          mRawBuff.unshift(path)
        }
        fetchCurrentImagePath()
      })
    }

    function fetchCurrentImagePath(){
      mRawBuff.unshift(mAllRawFiles.pop())
      mCurrentImageName = mRawBuff.pop()
      if(mCurrentImageName != undefined){
        mImg.src = "file://"+RAW_DIR + mCurrentImageName
        notifyRawBuffChanged()
      }
    }

    function notifyRawBuffChanged(){
      for (var i=0; i<mRawBuff.length && i<mRawImages.length; i++){
        mRawImages[i].src = RAW_DIR + mRawBuff[i]
      }
    }

    function keyDown(event){
      switch (event.keyCode) {
        case KEY_CODE_CMD:
          mIsCmdPressed = true
          break;
        case KEY_CODE_CTRL:
          mIsCtrlPressed = true
          break;
        case KEY_CODE_SHIFT:
          mIsShiftPressed = true
          break;
      }
    }

    function keyUp(event){
      switch (event.keyCode) {
        case KEY_CODE_CMD:
          mIsCmdPressed = false
          break;
        case KEY_CODE_CTRL:
          mIsCtrlPressed = false
          break;
        case KEY_CODE_SHIFT:
          mIsShiftPressed = false
          break;
      }
    }
  </script>
</html>
